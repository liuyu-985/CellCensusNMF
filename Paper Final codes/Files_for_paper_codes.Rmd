# summary_stats_celltypes.RData
library(data.table)
library(Singlet)

emb_path <- "/mnt/projects/debruinz_project/yu_ting/adata_obsm.csv"
obs_path <- "/mnt/home/liuyu/adata_obs.csv"

emb <- fread(emb_path, header = TRUE)
obs <- fread(obs_path,  header = TRUE)


if ("V1" %in% names(emb)) emb[, V1 := NULL]
if ("V1" %in% names(obs)) obs[, V1 := NULL]

stopifnot(nrow(emb) == nrow(obs))

keep <- rowSums(is.na(obs)) < ncol(obs)
emb  <- emb[keep]
obs  <- obs[keep]

emb_mat <- t(as.matrix(emb))       
cell_types <- obs$cell_type

stopifnot(ncol(emb_mat) == length(cell_types))

summary_stats <- MetadataSummary(emb_mat, cell_types)

save(summary_stats, file = "/mnt/projects/debruinz_project/yu_ting/summary_stats_celltypes.RData")

# padj_matrix_new_allFactors.csv 
library(msigdbr)
library(fgsea)
library(dplyr)
library(tidyr)
library(BiocParallel)

main_dir <- "/mnt/projects/debruinz_project/yu_ting"
base_dir <- file.path(main_dir, "200 factors W matrix")

var_data <- read.csv(
  file.path(main_dir, "adata_var_metadata_unique.csv"),
  stringsAsFactors = FALSE
)

emb_raw <- read.csv(
  file.path(main_dir, "adata_var_embeddings_unique.csv"),
  stringsAsFactors = FALSE
)


stopifnot(nrow(var_data) == nrow(emb_raw))


msigdbr_df   <- msigdbr(species = "Homo sapiens", category = "C5")
msigdbr_list <- split(msigdbr_df$gene_symbol, msigdbr_df$gs_name)


n_factors <- ncol(emb_raw)
all_fgsea <- vector("list", length = n_factors)
bp        <- MulticoreParam(workers = 30)


for (i in seq_len(n_factors)) {
  factor_name <- colnames(emb_raw)[i]

  
  rv <- emb_raw[[i]] %>% as.numeric()
  names(rv) <- var_data$feature_name
  rv <- sort(rv[rv != 0], decreasing = TRUE)

  
  fg <- fgsea(
    pathways  = msigdbr_list,
    stats     = rv,
    eps       = 0.0,
    scoreType = "pos",
    minSize   = 25,
    maxSize   = 500,
    BPPARAM   = bp
  )

 
  all_fgsea[[i]] <- fg %>%
    select(pathway, NES, padj) %>%
    mutate(factor = factor_name)
}

combined <- bind_rows(all_fgsea)

nes_mat <- combined %>%
  select(pathway, factor, NES) %>%
  pivot_wider(names_from = factor, values_from = NES) %>%
  arrange(pathway)

padj_mat <- combined %>%
  select(pathway, factor, padj) %>%
  pivot_wider(names_from = factor, values_from = padj) %>%
  arrange(pathway)

write.csv(padj_mat, file =
            file.path(base_dir, "padj_matrix_new_allFactors.csv"),
          row.names = FALSE)


# padj_matrix_narrow.csv and nes_matrix_narrow.csv
library(msigdbr)
library(fgsea)
library(dplyr)
library(tidyr)
library(tibble)        # for column_to_rownames()
library(BiocParallel)


main_dir <- "/mnt/projects/debruinz_project/yu_ting"
base_dir <- file.path(main_dir, "200 factors W matrix")

var_data <- read.csv(file.path(main_dir, "adata_var_metadata_unique.csv"),
                     stringsAsFactors = FALSE)
emb_raw  <- read.csv(file.path(main_dir, "adata_var_embeddings_unique.csv"),
                     stringsAsFactors = FALSE)
stopifnot(nrow(var_data) == nrow(emb_raw))


msigdbr_df   <- msigdbr(species = "Homo sapiens", category = "C5")
msigdbr_list <- split(msigdbr_df$gene_symbol, msigdbr_df$gs_name)


gs_sizes     <- lengths(msigdbr_list)
msigdbr_list <- msigdbr_list[gs_sizes <= 300]

n_factors <- ncol(emb_raw)
all_fgsea <- vector("list", n_factors)
bp        <- SerialParam()  

for (i in seq_len(n_factors)) {
  f_name <- colnames(emb_raw)[i]

  
  rv <- as.numeric(emb_raw[[i]])
  names(rv) <- var_data$feature_name
  rv <- rv[is.finite(rv) & rv != 0]
  if (length(rv) < 25) next
  set.seed(42)
  rv <- rv + rnorm(length(rv), sd = .Machine$double.eps)
  rv <- sort(rv, decreasing = TRUE)

  fg <- fgsea(
    pathways  = msigdbr_list,
    stats     = rv,
    eps       = 0.0,
    scoreType = "pos",
    minSize   = 25,
    maxSize   = 300,
    BPPARAM   = bp
  )

  all_fgsea[[i]] <- fg %>%
    select(pathway, NES, padj) %>%
    mutate(factor = f_name)
}


combined <- bind_rows(all_fgsea)
sig_counts <- combined %>%
  group_by(pathway) %>%
  summarize(n_sig = sum(padj < 0.05), .groups = "drop")

combined <- combined %>%
  filter(pathway %in% sig_counts$pathway[sig_counts$n_sig <= 50])


nes_mat <- combined %>%
  select(pathway, factor, NES) %>%
  pivot_wider(names_from = factor, values_from = NES) %>%
  arrange(pathway)

padj_mat <- combined %>%
  select(pathway, factor, padj) %>%
  pivot_wider(names_from = factor, values_from = padj) %>%
  arrange(pathway)


nes_mat2 <- nes_mat %>%
  column_to_rownames("pathway")

var_nes <- apply(nes_mat2, 1, var, na.rm = TRUE)

q25 <- quantile(var_nes, 0.25, na.rm = TRUE)

keep_var <- names(var_nes)[!is.na(var_nes) & var_nes >= q25]

nes_mat  <- nes_mat  %>% filter(pathway %in% keep_var)
padj_mat <- padj_mat %>% filter(pathway %in% keep_var)

write.csv(nes_mat,  file.path(base_dir, "nes_matrix_narrow.csv"),
          row.names = FALSE)
write.csv(padj_mat, file.path(base_dir, "padj_matrix_narrow.csv"),
          row.names = FALSE)

# seurat_norm.rds 
library(reticulate)
use_virtualenv("r-reticulate", required = TRUE)
py_install(c("scanpy", "anndata"), envname = "r-reticulate", pip = TRUE)
sc    <- import("scanpy")
library(Matrix)
library(Seurat)
adata <- sc$read_h5ad(
  "/mnt/projects/debruinz_project/yu_ting/200 factors W matrix/transfer_learning_data.h5ad"
)
counts_mat <- Matrix(adata$X, sparse = TRUE)
counts_mat <- t(counts_mat)

rownames(counts_mat) <- adata$var_names$to_list()  # length 36390
colnames(counts_mat) <- adata$obs_names$to_list()  # length 96479
dim(counts_mat)

seurat_obj <- CreateSeuratObject(
  counts    = counts_mat,
  project   = "transfer_learning",
  assay     = "RNA",
  min.cells = 3,
  min.features = 200
)

colnames(seurat_obj@meta.data)
obs_df  <- as.data.frame(py_to_r(adata$obs))
rownames(obs_df) <- adata$obs_names$to_list()
colnames(obs_df)
celltype_meta <- obs_df[, "cell_type", drop = FALSE]
all(rownames(celltype_meta) == colnames(seurat_obj))
disease_meta <- obs_df[, "disease", drop = FALSE]
all(rownames(disease_meta) == colnames(seurat_obj))

seurat_obj <- AddMetaData(
     object   = seurat_obj,
     metadata = celltype_meta
 )
celltype_meta <- seurat_obj@meta.data["cell_type"]
seurat_obj <- AddMetaData(
     object   = seurat_obj,
     metadata = disease_meta
 )
disease_meta <- seurat_obj@meta.data["disease"]

raw_counts <- GetAssayData(
     object = seurat_obj,
     assay  = "RNA",
     layer  = "counts"
 )


library(readr)
library(dplyr)
w_ref <- read_csv("/mnt/projects/debruinz_project/yu_ting/adata_var_embeddings_unique.csv")
var_meta <- read_csv("/mnt/projects/debruinz_project/yu_ting/adata_var_metadata_unique.csv")
intersect(rownames(raw_counts), var_meta$feature_id)
w_ref <- w_ref %>% mutate(index = row_number())
var_meta <- var_meta %>% mutate(index = row_number())
w_ref <- left_join(var_meta %>% select(index, feature_id),
                     w_ref,
                     by = "index")

library(tibble)
w_ref_matrix <- w_ref %>%
  column_to_rownames(var = "feature_id") %>% 
  select(-index) %>%                           
  as.matrix()                                  

dim(w_ref_matrix)
# 36390 200

common_genes <- intersect(rownames(raw_counts), rownames(w_ref_matrix))
length(common_genes) 
raw_counts_sub  <- raw_counts[common_genes,    , drop = FALSE]
w_ref_matrix_sub      <- w_ref_matrix[common_genes,  , drop = FALSE]
dim(raw_counts_sub)  
dim(w_ref_matrix_sub) 


counts_sub <- raw_counts_sub
seurat_norm <- CreateSeuratObject(
  counts    = counts_sub,
  assay     = "alignedRNA",
  project   = "transfer_learning"
)
seurat_norm <- AddMetaData(
     object   = seurat_norm,
     metadata = celltype_meta
 )

seurat_norm <- AddMetaData(
     object   = seurat_norm,
     metadata = disease_meta
 )

seurat_norm <- NormalizeData(
  seurat_norm,
  assay                 = "alignedRNA",
  normalization.method  = "LogNormalize",
  scale.factor          = 1e4
)


library(Matrix)
library(singlet)
library(SingleCellExperiment)

best_rank <- 70
A <- as(norm_mat, "dgCMatrix")
set.seed(42)
nmf_mod <- run_nmf(
     A,               
     rank     = best_rank,
     verbose  = FALSE
)
W_deNovo <- nmf_mod$w    # 32648 × 70
H_deNovo <- nmf_mod$h    # 70 × 96479

library(Seurat)

colnames(H_deNovo) <- colnames(seurat_norm)          
rownames(H_deNovo) <- paste0("NMF", seq_len(nrow(H_deNovo)))  

rownames(W_deNovo) <- rownames(seurat_norm)   
colnames(W_deNovo) <- rownames(H_deNovo)      
 
seurat_norm[["nmf"]] <- CreateDimReducObject(
  embeddings = t(H_deNovo),   
  loadings   = W_deNovo,      
  key        = "NMF_",        
  assay      = "alignedRNA"   
)

library(RcppML)
library(Seurat)

common_genes <- intersect(rownames(norm_mat), rownames(w_ref_matrix_sub))
A_sub <- norm_mat[common_genes,    , drop = FALSE]  
W_sub <-  w_ref_matrix_sub[common_genes, , drop = FALSE] 


H_proj <- project(A_sub, w = W_sub)

rownames(H_proj) <- paste0("NMFproj", seq_len(nrow(H_proj)))
colnames(H_proj) <- colnames(norm_mat)

seurat_norm[["nmf_proj"]] <- CreateDimReducObject(
  embeddings = t(H_proj),  
  loadings   = W_sub,      
  key        = "NMFproj_",
  assay      = "alignedRNA"
)

saveRDS(seurat_norm, file = "/mnt/projects/debruinz_project/yu_ting/seurat_norm.rds")

